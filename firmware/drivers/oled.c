#include "oled.h"
#include <ch.h>
#include <hal.h>
#include <string.h>

#define OLED_SPID     SPID1
#define OLED_RST_PORT GPIOB
#define OLED_RST_PIN  GPIOB_OLED_RST
#define OLED_DC_PORT  GPIOA
#define OLED_DC_PIN   GPIOA_OLED_DC

uint8_t oled_buffer[4][128];

static uint8_t oled_init_cmds[] = {
    0xAE,       /* OLED panel off */
    0xD5, 0x70, /* Display clock divide: default freq, div by 1 */
    0xA8, 0x1F, /* MUX ratio: 32MUX (as 32 rows) */
    0xD3, 0x00, /* Display offset: not offset */
    0xD8, 0x05, /* Area Colour Mode: monochrome, low power mode */
    0xA1,       /* Segment remap: Remap columns, flipping left/right */
    0xC8,       /* COM scan direction: Flipped top/bottom */
    0xDA, 0x12, /* COM pins hardware config: L/R remap + alt config */
    0x91, 0x3F, 0x3F, 0x3F, 0x3F, /* Current drive pulse widths */
    0xD9, 0x22, /* Pre-charge period: default values (example is 0xD2) */
    0xDB, 0x34, /* VCOMH: 0.77 * VCC (default) */
    0xA6,       /* Normal (not inverse) display */
    0xA4,       /* Disable entire display ON */
    0x20, 0x00, /* Memory addressing mode: horizontal */
    0x21, 4, 131, /* Start at column 4, end at column 131 (NB 0xA1 remap) */
    0x22, 0x00, 0x03, /* Start page 0, end at page 3 (as 4 rows of 8 pix) */
    0x81, 0xFF, /* Contrast control: maximum contrast */
    0x82, 0xFF, /* Set maximum brightness for colour banks */
    0xAD, 0x8F, /* Master configuration: DC-DC enabled */
    0xAF,       /* OLED panel on, normal (not dim) mode */
};

static uint8_t oled_sv_logo[4][128] = {
    { 0xFF, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0xFF     },
    { 0xFF, 0x00, 0x7C, 0xFE, 0xFE, 0xFF, 0xE7, 0xC3, 0xC3, 0xC3, 0xC3, 0x87,
0x8F, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00,
0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0x03,
0x03, 0x03, 0x87, 0xFF, 0xFE, 0xFE, 0x78, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF,
0xFF, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0x03, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF,
0xFF, 0xFF, 0x83, 0x83, 0x83, 0xFF, 0xFF, 0x7E, 0x3C, 0x00, 0x00, 0x01, 0x0F,
0x7F, 0xFF, 0xFE, 0xF0, 0x80, 0x00, 0x80, 0xF0, 0xFE, 0xFF, 0x7F, 0x0F, 0x01,
0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF,
0x03, 0x03, 0x03, 0x03, 0x07, 0x1E, 0xFE, 0xFC, 0xF8, 0xF0, 0x00, 0x00, 0x00,
0xFF, 0xFF, 0xFF, 0xFF, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0x03, 0x00, 0xFF     },
    { 0xFF, 0x00, 0x38, 0x70, 0x70, 0x61, 0x61, 0x61, 0x61, 0x73, 0x7F, 0x3F,
0x3F, 0x1F, 0x00, 0x00, 0x00, 0x0F, 0x3F, 0x3F, 0x7F, 0x70, 0x60, 0x60, 0x60,
0x70, 0x7F, 0x3F, 0x3F, 0x0F, 0x00, 0x00, 0x00, 0x7F, 0x7F, 0x7F, 0x7F, 0x03,
0x03, 0x03, 0x03, 0x03, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x7F, 0x7F, 0x7F,
0x7F, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x00, 0x00, 0x00, 0x00, 0x7F, 0x7F,
0x7F, 0x7F, 0x01, 0x01, 0x07, 0x1F, 0x7F, 0x7E, 0x7C, 0x70, 0x40, 0x00, 0x00,
0x00, 0x03, 0x1F, 0x7F, 0x7F, 0x7C, 0x7F, 0x7F, 0x1F, 0x03, 0x00, 0x00, 0x00,
0x00, 0x00, 0x7F, 0x7F, 0x7F, 0x7F, 0x00, 0x00, 0x00, 0x7F, 0x7F, 0x7F, 0x7F,
0x60, 0x60, 0x60, 0x60, 0x70, 0x3C, 0x3F, 0x1F, 0x0F, 0x07, 0x00, 0x00, 0x00,
0x7F, 0x7F, 0x7F, 0x7F, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x00, 0xFF     },
    { 0xFF, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0xFF     },
};

void oled_init() {
    /* Reset OLED */
    palClearPad(OLED_RST_PORT, OLED_RST_PIN);
    chThdSleepMilliseconds(500);
    palSetPad(OLED_RST_PORT, OLED_RST_PIN);

    /* SPI Config */
    const SPIConfig spi_cfg = {
      NULL, GPIOB, GPIOB_OLED_CS,
      SPI_CR1_BR_2 | SPI_CR1_CPOL | SPI_CR1_CPHA
    };

    spiStart(&OLED_SPID, &spi_cfg);

    /* Send initialisation commands */
    palClearPad(OLED_DC_PORT, OLED_DC_PIN);
    spiSelect(&OLED_SPID);
    spiSend(&OLED_SPID, sizeof(oled_init_cmds), (void*)oled_init_cmds);
    spiUnselect(&OLED_SPID);
}

void oled_draw_logo() {
    memcpy(oled_buffer, oled_sv_logo, sizeof(oled_sv_logo));
    oled_draw();
}

void oled_draw()
{
    /* Write the buffer to the OLED */
    palSetPad(OLED_DC_PORT, OLED_DC_PIN);
    spiSelect(&OLED_SPID);
    spiSend(&OLED_SPID, 128*4, (void*)oled_buffer);
    spiUnselect(&OLED_SPID);
}
